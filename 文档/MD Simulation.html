<!DOCTYPE html>
<html>
<head>
<title>MD Simulation.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: "Segoe WPC", "Segoe UI", "SFUIText-Light", "HelveticaNeue-Light", sans-serif, "Droid Sans Fallback";
	font-size: 14px;
	padding: 0 12px;
	line-height: 22px;
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}


body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	color: #4080D0;
	text-decoration: none;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

h1 code,
h2 code,
h3 code,
h4 code,
h5 code,
h6 code {
	font-size: inherit;
	line-height: auto;
}

a:hover {
	color: #4080D0;
	text-decoration: underline;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left: 5px solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 14px;
	line-height: 19px;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

.mac code {
	font-size: 12px;
	line-height: 18px;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

/** Theming */

.vscode-light,
.vscode-light pre code {
	color: rgb(30, 30, 30);
}

.vscode-dark,
.vscode-dark pre code {
	color: #DDD;
}

.vscode-high-contrast,
.vscode-high-contrast pre code {
	color: white;
}

.vscode-light code {
	color: #A31515;
}

.vscode-dark code {
	color: #D7BA7D;
}

.vscode-light pre:not(.hljs),
.vscode-light code > div {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre:not(.hljs),
.vscode-dark code > div {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre:not(.hljs),
.vscode-high-contrast code > div {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

.vscode-light blockquote,
.vscode-dark blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.vscode-high-contrast blockquote {
	background: transparent;
	border-color: #fff;
}
</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family:  "Meiryo", "Segoe WPC", "Segoe UI", "SFUIText-Light", "HelveticaNeue-Light", sans-serif, "Droid Sans Fallback";
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

</head>
<body>
<h1 id="%E5%88%86%E5%AD%90%E5%8A%A8%E5%8A%9B%E5%AD%A6%E6%A8%A1%E6%8B%9F">分子动力学模拟</h1>
<h2 id="1-%E5%87%86%E5%A4%87">1. 准备</h2>
<h3 id="11-boldsymboltriangle%E8%8E%B7%E5%8F%96roughpolymerpdb%E5%8E%9F%E5%A7%8B%E7%B2%97%E7%B3%99%E7%9A%84pdb%E6%96%87%E4%BB%B6">1.1 $\boldsymbol{^\triangle}$获取roughpolymer.pdb(原始粗糙的pdb文件)</h3>
<ul>
<li>在Material Studio中画出聚合物分子，导出<strong>roughpolymer.pdb</strong>文件。<strong>注意头尾：头部结构单元CA有HA1，尾部CY有HY1。</strong></li>
<li>改残基名。对于f5均聚物，残基命名为头部、中间、尾部结构单元分别为DDR、DDS、DDT。</li>
</ul>
<p>$\boldsymbol{^\triangle}$ <em>表示有些情况可能并非必须步骤。</em></p>
<h3 id="12-boldsymboltriangleroughpolymerpdb%E8%BD%AC%E6%8D%A2%E6%88%90polymergro">1.2 $\boldsymbol{^\triangle}$roughpolymer.pdb转换成polymer.gro</h3>
<pre class="hljs"><code><div><span class="hljs-meta">$</span><span class="bash"> pdb2gmx -f polymer.pdb -o polymer.gro -p polymer.top</span>
    &gt; Force Field: 8 Charmm27
    &gt; Water Model: 7 None
</div></code></pre>
<p>这一步可能报错：<code>Atom HN in residue DDS 14 was not found in rtp entry DDS with 51 atom while sorting atoms</code>
这是因为pdb文件里面的原子名没有改好，如上例中，有一个氢命名是力场文件中没有的，所以要改pdb。</p>
<p>也可能因为DDS DDT写混了。</p>
<p>即得到<strong>polymer.gro</strong>、<strong>polymer.top</strong>两个文件，其中gro需要做得与x轴平行，top文件需要改动成itp文件供后面top文件#include。下述</p>
<h3 id="13-boldsymboltrianglepolymergro%E6%94%B9%E5%88%B0%E4%B8%8Ex%E8%BD%B4%E5%B9%B3%E8%A1%8C">1.3 $\boldsymbol{^\triangle}$polymer.gro改到与x轴平行</h3>
<ul>
<li><em>PASS</em>
得到<strong>refined_polymer.gro</strong></li>
<li><code>$ editconf -f refined_polymer.gro -o refined_polymer.pdb</code>
得到<strong>refined_polymer.pdb</strong></li>
</ul>
<h3 id="14-polymertop%E6%94%B9%E4%B8%BApolymeritp%E3%80%81%E5%B0%86polymeritp%E5%8A%A0%E5%85%A5%EF%BC%88include%EF%BC%89%E5%88%B0graphenetop">1.4 polymer.top改为polymer.itp、将polymer.itp加入（include）到graphene.top</h3>
<ul>
<li><strong>polymer.top</strong>打开，[ bonds ]、[ angles ]、[ dihedrals ]里面的各种常数依据<strong>124-order.itp</strong>文件改。<strong>这一步可能反复出错，根据报错中声明缺少参数的行数来改。是最<s>恶心</s>繁复耗时的步骤。</strong></li>
<li>删除以下两个部分，分别在头部和尾部<pre class="hljs"><code><div>; Include forcefield parameters
#include &quot;charmm27.ff/forcefield.itp&quot;
</div></code></pre>
<pre class="hljs"><code><div>; Include Position restraint file
#ifdef POSRES
……
[ molecules ]
; Compound        #mols
Other               1
</div></code></pre>
</li>
<li><strong>polymer.top</strong>改名为<strong>polymer.itp</strong></li>
<li>在<strong>graphene.top</strong>文件中加一句<code>#include polymer.itp</code>，也可能是把里面别的itp文件名改成<strong>polymer.itp</strong>。</li>
</ul>
<h3 id="15-%E4%BF%AE%E6%94%B9packin%E6%96%87%E4%BB%B6%E3%80%81%E5%9D%90%E6%A0%87%E6%96%87%E4%BB%B6%E6%89%93%E5%8C%85%E3%80%81%E5%BB%BA%E7%9B%92%E5%AD%90%E3%80%81%E4%BF%AE%E6%94%B9complexpdb%E7%9A%84%E6%AE%8B%E5%9F%BA%E5%BA%8F%E5%8F%B7">1.5 修改pack.in文件、坐标文件打包、建盒子、修改complex.pdb的残基序号</h3>
<ul>
<li>
<p><code>$ packmol &lt; pack.in</code>包含石墨烯（<strong>graphene.pdb</strong>）+改良的聚合物pdb文件   （<strong>refined_polymer.pdb</strong>），<strong>pack.in</strong>文件中的距离单位为$\mathring{A}$。
得到<strong>complex.pdb</strong></p>
</li>
<li>
<p>建盒子</p>
<pre class="hljs"><code><div><span class="hljs-meta">$</span><span class="bash"> editconf -f complex.pdb -o complex.gro -c -box &lt;X&gt; &lt;Y&gt; &lt;Z&gt; <span class="hljs-comment"># 其中XYZ的单位是nm。</span></span>
</div></code></pre>
</li>
<li>
<p>修改<strong>complex.pdb</strong>的残基序号。1UNK保留不动；1DDR-nDDS-28DDT改为2DDR-nDDS-29DDT。</p>
</li>
</ul>
<h3 id="16-%E7%B4%A2%E5%BC%95%E3%80%81%E5%9B%BA%E5%AE%9A%E3%80%81%E6%94%B9posreitp%E7%9A%84%E5%8A%9B%E5%B8%B8%E6%95%B0">1.6 索引、固定、改posre.itp的力常数</h3>
<ul>
<li>索引。<pre class="hljs"><code><div><span class="hljs-meta">$</span><span class="bash"> make_ndx -f complex.gro -o new.ndx</span>
    &gt; 3|4|5 # 分别指的是DDR、DDS、DDT。
    &gt; name 6 F5
</div></code></pre>
</li>
<li>固定。<pre class="hljs"><code><div>genrestr -f complex.gro -n new.ndx -o posre.itp
    &gt; 'select a group': 2 # 选择固定石墨烯组 
</div></code></pre>
</li>
<li>$^\triangle$<strong>posre.itp</strong>里面的1000改成10000。</li>
</ul>
<p>至此我们得到了以下文件</p>
<table>
<thead>
<tr>
<th>文件</th>
<th>来源</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>complex.gro</td>
<td>1.5 节 <code>editconf</code></td>
<td></td>
</tr>
<tr>
<td>em1.mdp &amp; npt1.mdp &amp; nvt1.mdp</td>
<td>某处复制得来</td>
<td></td>
</tr>
<tr>
<td>graphene.top</td>
<td>1.4 节</td>
<td>要加上include polymer.itp</td>
</tr>
<tr>
<td>new.ndx</td>
<td>1.6 节 <code>make_ndx</code></td>
<td></td>
</tr>
<tr>
<td>posre.itp</td>
<td>1.6 节<code>posre</code></td>
<td>要加入到graphene.top中</td>
</tr>
<tr>
<td>polymer.itp</td>
<td>1.4 节 删除、改名</td>
<td>要加入到graphene.top中</td>
</tr>
</tbody>
</table>
<h2 id="2-em%E8%83%BD%E9%87%8F%E6%9C%80%E5%B0%8F%E5%8C%96">2. EM(能量最小化)</h2>
<ul>
<li>打包<pre class="hljs"><code><div>grompp -v -c complex.gro -f em1.mdp -o emXX.tpr -p graphene.top -n new..ndx
</div></code></pre>
</li>
<li>运行<pre class="hljs"><code><div>mdrun -v -s emXX.tar -deffnm emXX
</div></code></pre>
</li>
</ul>
<h2 id="3-npt%E7%AD%89%E6%B8%A9%E7%AD%89%E5%8E%8B%E7%B3%BB%E7%BB%BC">3. NPT(等温等压系综)</h2>
<p><a href="https://zhuanlan.zhihu.com/p/26103312">分子动力学模拟简介--知乎用户@yang元祐</a>：</p>
<blockquote>
<p>等温等压系综(constant-pressure,constant-temperature)，简称NPT或者T-P系综。即表示具有确定的粒子数（N）、压强（P）、温度（T）。一般是在蒙特卡罗模拟中实现。其总能量(E)和系统体积(V)可能存在起伏。体系是可移动系统壁情况下的恒温热浴。特征函数是吉布斯自由能G(N,P,T)。</p>
</blockquote>
<p>npt1.mdp文件中的</p>
<pre class="hljs"><code><div>xtc_grps            = UNK WDA
energygrps          = UNK WDA
……
tc-grps             = UNK WDA   ;2 coupling group
</div></code></pre>
<p>组名需要按需求改掉。如组名WDA改成F5，这个组名是在<code>make_ndx</code>的时候命名的那个。</p>
<ul>
<li>打包<pre class="hljs"><code><div>grompp -v -c emXX.gro -f npt1.mdp -o nptYY-emXX.tar -p graphene.top -n new.ndx 
</div></code></pre>
<strong>nptYY-emXX.tar</strong>表示em第XX次跑完的结果用来跑的第YY次npt。</li>
<li>运行<pre class="hljs"><code><div>mdrun -v -s nptYY-emXX.tar -deffnm nptYY-emXX
</div></code></pre>
</li>
</ul>
<h2 id="4-nvt%E6%AD%A3%E5%88%99%E7%B3%BB%E7%BB%BC">4. NVT(正则系综)</h2>
<p><a href="https://zhuanlan.zhihu.com/p/26103312">分子动力学模拟简介--知乎用户@yang元祐</a>：</p>
<blockquote>
<p>正则系综（canonical ensemble），NVT，正则系综是蒙特卡罗方法模拟处理的典型代表。假定N个粒子处在体积为V的盒子内，将其置于温度恒为T的巨大热库中。此时，总能量（E）和系统压强（P）可能在某一平均值附近起伏变化。平衡体系为封闭系统，与大热源热接触，能量交换达到热平衡，温度相等，热库足够大，温度确定。特征函数是亥姆霍兹自由能F（N,V,T）。</p>
</blockquote>

</body>
</html>
